name: edam-browser

on:
  issue_comment:
    types: [created]

jobs:
  post-visualization-link:
    runs-on: ubuntu-latest
    # Only run on PR comments with /browser command
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request && 
      contains(github.event.comment.body, '/browser')
    permissions:
      contents: read        # Read repository files/code
      pull-requests: write  # Read PR details + post comments
    steps:
      - name: Get PR number
        id: pr_number
        uses: actions/github-script@v7
        with:
          script: |
            // For issue_comment on PRs, the issue number is the PR number
            const prNumber = context.issue.number;
            core.setOutput('number', prNumber);
            return prNumber;

      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Get PR details
        id: pr_details
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr_number.outputs.number }}
            });
            
            core.setOutput('branch', pr.head.ref);
            core.setOutput('owner', pr.head.repo.owner.login);
            core.setOutput('repo', pr.head.repo.name);
            core.setOutput('sha', pr.head.sha);

      - name: Check if EDAM_dev.owl exists in PR
        id: check_file
        uses: actions/github-script@v7
        with:
          script: |
            // Check if file exists in the branch
            try {
              await github.rest.repos.getContent({
                owner: '${{ steps.pr_details.outputs.owner }}',
                repo: '${{ steps.pr_details.outputs.repo }}',
                path: 'EDAM_dev.owl',
                ref: '${{ steps.pr_details.outputs.sha }}'
              });
              core.setOutput('exists', true);
              return true;
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('exists', false);
                return false;
              }
              throw error;
            }

      - name: Post or update comment
        if: steps.check_file.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = '${{ steps.pr_details.outputs.owner }}';
            const repo = '${{ steps.pr_details.outputs.repo }}';
            const sha = '${{ steps.pr_details.outputs.sha }}';
            
            // Use commit SHA for more reliable access
            const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${sha}/EDAM_dev.owl`;
            const visualizationUrl = `https://edamontology.github.io/edam-browser/#topic_0091&version=${rawUrl}`;
            
            const commentBody = `## üîç EDAM Visualization
            
            The \`EDAM_dev.owl\` file for commit \`${sha}\` is available for visualization.
            
            **[üëâ View it in EDAM Browser](${visualizationUrl})**
            
            ---
            <sub>üí° Tip: Comment \`\/browser\` to regenerate this link</sub>`;
            
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr_number.outputs.number }},
              body: commentBody
            });

      - name: Add success reaction
        if: steps.check_file.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Post error comment
        if: steps.check_file.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr_number.outputs.number }},
              body: '‚ö†Ô∏è The `EDAM_dev.owl` file was not found in this PR branch.'
            });
            
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'confused'
            });
